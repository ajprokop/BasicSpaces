self.AvayaClientServicesWorker={},function(e){"use strict";function t(){}t.prototype={compareBlocks:function(e,t,r,n,o,a){for(var i=[],s=t.length,c=0;c<s;c++){e[c]=e[c]||[];for(var _=t[c].length,h=0;h<_;h++)this._compareBlock(e,t[c][h],i,h,c,r,n,o,a)}return i},_compareBlock:function(e,t,r,n,o,a,i,s,c){for(var _="",h=t.data.length,l=0;l<h;l++)_+=btoa(t.data[l]);var u=e[o][n];u&&_===u.base64||((i={_width:t.width,_height:t.data.length,_x:o*a,_y:n*i,_row:n,_column:o,_blocks:[],_data:t.data})._type=this._determineType(i._data,s,c),r.push(i),e[o][n]={base64:_})},_determineType:function(e,t,r){for(var n,o,a,i={},s=0,c=e.length,_=0;_<c;_++)for(a=(n=r(e[_])).length,o=0;o<a;o++){var h=""+(16777215&n[o]);if(i[h]||(i[h]=0,s++),t<s)return 0;i[h]++}return 1}},e.BlocksComparator=t}(self.AvayaClientServicesWorker),function(e){"use strict";function t(){}t.prototype={generateBlocks:function(e,t,r,n,o){for(var a=[],i=r.length,s=4*n,c=4*e,_=0,h=0;_<i;_+=s,h++)for(var l=Math.floor(h/t),u=0;u<s;u+=c){var g=c;s<u+g&&(g=s-u);var f=Math.floor(u/c);a[f]||(a[f]=[]);var p=a[f][l]||{data:[],width:g/4};p.data=o(p,r.slice(_+u,_+u+g)),a[f][l]=p}return a}},e.BlocksGenerator=t}(self.AvayaClientServicesWorker),function(e){"use strict";function t(){}t.prototype={mergeBlocks:function(e,t){return e=this._sortByRow(e),e=this._mergeByRow(e,t),e=this._sortByColumn(e),(e=this._mergeByColumn(e)).map(this._createMergedBlock)},_sortByColumn:function(e){return e.sort(function(e,t){return e._column===t._column?e._row-t._row:e._column-t._column})},_sortByRow:function(e){return e.sort(function(e,t){return e._row===t._row?e._column-t._column:e._row-t._row})},_compareBlocksByColumn:function(e,t){return e._x===t._x&&e._type===t._type&&e._width===t._width&&(e._y+e._height===t._y||t._y+t._height===e._y)},_compareBlocksByRow:function(e,t){return e._y===t._y&&e._type===t._type&&e._height===t._height&&(e._x+e._width===t._x||t._x+t._width===e._x)},_merge:function(e,t,r){for(var n=[],o=this._copyBlock(e[0]),a=1;a<e.length;a++)t(o,e[a])?(0<e[a]._blocks.length?this._copyBlocks(e,a,o):o._blocks.push(e[a]),r(o,e[a])):(n.push(o),o=this._copyBlock(e[a]));return n.push(o),n},_mergeByColumn:function(e){return this._merge(e,this._compareBlocksByColumn,function(e,t){e._height+=t._height,e._data=e._data.concat(t._data)})},_mergeByRow:function(e,r){return this._merge(e,this._compareBlocksByRow,function(e,t){r(e,t),e._width+=t._width})},_copyBlocks:function(e,t,r){e[t]._blocks.forEach(function(e){r._blocks.push(e)})},_copyBlock:function(e){var t;return 0===e._blocks.length?(t={_x:e._x,_y:e._y,_row:e._row,_column:e._column,_width:e._width,_height:e._height,_type:e._type,_blocks:[],_data:e._data})._blocks.push(e):t=e,t},_createMergedBlock:function(e){var t=e._data.reduce(function(e,t){return Array.prototype.push.apply(e,t),e},[]),t=new ImageData(new Uint8ClampedArray(t),e._width,e._height);return{_x:e._x,_y:e._y,_row:e._row,_column:e._column,_width:e._width,_height:e._height,_type:e._type,_imgData:t}}},e.BlocksMerger=t}(self.AvayaClientServicesWorker),function(S){"use strict";function e(e,t,r){this._blocksGenerator=e,this._blocksComparator=t,this._blocksMerger=r,this._config=void 0,this._generatingKeyFrame=!0,this._previousWidth=-1,this._previousHeight=-1,this._generatedFrames=0,this._previousScreen=void 0}e.prototype={setKeyFrameGeneration:function(e){this._generatingKeyFrame=e},generateChangedBlocks:function(e,t,r,n){var o={};this._config=t,this._determineKeyFrameGeneration(r,n);t=Date.now();o.prepareScreenTime=Date.now()-t,this._generatingKeyFrame?(this._previousScreen=[],this._generatingKeyFrame=!1,o.isKeyFrame=!0):o.isKeyFrame=!1;var t=Date.now(),n=[],a={},i=new Uint32Array(e.buffer);if(this._previousScreen&&0<this._previousScreen.length)for(var s,c,_=0;_<i.length;_++)this._previousScreen[_]!==i[_]&&(s=~~((c=~~(_/r))/this._config.blockSize),a[c=~~((_-c*r)/this._config.blockSize)]=a[c]||[],a[c].includes(s)||(a[c][a[c].length]=s),_+=this._config.blockSize-_%this._config.blockSize);return this._previousScreen&&0<this._previousScreen.length&&0===Object.keys(a).length||(this._previousScreen=i,n=this._quickDetermineChangedBlocks(a,e,r)),o.determineChangedBlocksTime=Date.now()-t,0<n.length&&(t=Date.now(),n=this._blocksMerger.mergeBlocks(n,this._mergeByRow.bind(this)),o.mergeBlocksTime=Date.now()-t,this._generatedFrames++),{changedBlocks:n,meta:o}},_determineKeyFrameGeneration:function(e,t){this._generatedFrames===this._config.framesPerKeyFrame&&(this._generatingKeyFrame=!0,this._generatedFrames=0),e===this._previousWidth&&t===this._previousHeight||(this._previousWidth=e,this._previousHeight=t,this._generatingKeyFrame=!0)},_quickDetermineChangedBlocks:function(e,_,t){var d=[],h=_.length,l=4*t,u=4*this._config.blockSize,r=function(e,t,r){for(var n,o,a,i={_width:r.width,_height:r.data.length,_x:e*this._config.blockSize,_y:t*this._config.blockSize,_row:t,_column:e,_blocks:[],_data:r.data,_type:S.ScreenSharingImageTypes.PNG},s={},c=0,_=!1,h=0,l=!1,u=!1,g=0;g<i._data.length&&!_;g+=2)for(var f=this._prepareBuffer(i._data[g]),p=0;p<f.length&&!_;p++)if(a=16777215&f[p],c<=this._config.losslessColorLimit&&!s[a]&&(s[a]=!0,c++),n=a>>8&255,o=a>>16&255,(65<(a=255&a)&&n<35||180<a&&n<55)&&(l=!0),(u=a<130&&n<130&&o<130||180<o?!0:u)&&l&&(h++,u=l=!1),c>=this._config.losslessColorLimit&&(i._type=S.ScreenSharingImageTypes.JPEG),16<h){i._type=S.ScreenSharingImageTypes.JPEG_RED_WITH_BLACK,_=!0;break}d.push(i)}.bind(this);if(0!==Object.keys(e).length){var n,o=function(e,t){for(var r={data:[],width:0},n=t,o=n*this._config.blockSize,a=o*l;n===t&&a<h;a+=l,n=~~(++o/this._config.blockSize))for(var i=e,s=i*u;i===e&&s<l;i=~~((s+=u)/u)){var c=u;l<s+c&&(c=l-s),r.width=c/4,r.data=this._prepareBlockData(r,_.slice(a+s,a+s+c))}return r}.bind(this);for(n in e)if(e.hasOwnProperty(n))for(var a=0;a<e[n].length;a++){var i=o(parseInt(n),e[n][a]);r(n,e[n][a],i)}}else{for(var s=[],c=0,g=0;c<h;c+=l,g++)for(var f=~~(g/this._config.blockSize),p=0;p<l;p+=u){var y=u;l<p+y&&(y=l-p);var m=~~(p/u);s[m]||(s[m]=[]);var k=s[m][f]||{data:[],width:y/4};k.data=this._prepareBlockData(k,_.slice(c+p,c+p+y)),s[m][f]=k}for(var v=0;v<s.length;v++)for(var w=s[v].length,B=0;B<w;B++)r(v,B,s[v][B])}return d},_prepareScreen:function(e){return e},_prepareBlockData:function(e,t){return e.data=e.data.concat(t),e.data},_prepareBuffer:function(e){return new Uint32Array(e.buffer)},_mergeByRow:function(e,t){for(var r=Math.ceil(e._width/this._config.blockSize),n=0;n<t._data.length;n++)Array.prototype.splice.apply(e._data,[r+(r+1)*n,0].concat(t._data[n]))}},S.DataManipulator=e}(self.AvayaClientServicesWorker),function(){"use strict";self.AvayaClientServicesWorker.ScreenCapturerWorkerEvents={INITIALIZE:"initialize",CHANGED_BLOCKS:"changedBlocksMessage",SEND_IMAGE_DATA:"wholeImgData",WORKER_STARTED:"workerStarted"}}(),function(){"use strict";self.AvayaClientServicesWorker.ScreenSharingImageTypes={JPEG:0,PNG:1,JPEG_RED_WITH_BLACK:2}}(),function(o){"use strict";var a,i;self.onmessage=function(e){var t,r,n;e.data.type===o.ScreenCapturerWorkerEvents.INITIALIZE?(t=new o.BlocksGenerator,n=new o.BlocksComparator,r=new o.BlocksMerger,a=new o.DataManipulator(t,n,r),i=e.data.config,self.postMessage({type:o.ScreenCapturerWorkerEvents.WORKER_STARTED})):e.data.type===o.ScreenCapturerWorkerEvents.SEND_IMAGE_DATA&&(n=Date.now(),e.data.forceKeyFrame&&a.setKeyFrameGeneration(!0),e=(r=a.generateChangedBlocks(e.data.imgData,i,e.data.width,e.data.height)).changedBlocks.map(function(e){return e._imgData.data.buffer}),n={processingTime:Date.now()-n,processedBlocks:r.changedBlocks.length,keyFrame:r.meta.isKeyFrame,meta:r.meta,generatedPNGs:r.changedBlocks.reduce(function(e,t){return t._type===o.ScreenSharingImageTypes.PNG&&e++,e},0)},self.postMessage({type:o.ScreenCapturerWorkerEvents.CHANGED_BLOCKS,data:r.changedBlocks,meta:n},e))}}(self.AvayaClientServicesWorker);