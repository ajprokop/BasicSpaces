!function(_){var u=jQuery;!function(e){"use strict";e.Renderer=e.Renderer||{},e.Renderer.Konva=e.Renderer.Konva||{}}(AvayaClientServices),function(n){"use strict";function e(){this._contentSharing=_}e.prototype={init:function(e,i){(this._contentSharing=e).addOnCursorReceivedCallback(function(e,t){this.showCursor(t)}.bind(this)),e.addOnContentSharingStartedCallback(function(e,t){e={konvaSharingFramesAverageLimit:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingFramesAverageLimit")||2.5,konvaSharingFramesWarningLimit:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingFramesWarningLimit")||1,konvaSharingGracePeriod:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingGracePeriod")||15,konvaSharingMeasurementsInterval:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingMeasurementsInterval")||.5,konvaSharingMeasurementsWindowDuration:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingMeasurementsWindowDuration")||10,konvaSharingDebugMode:n.Base.Utils.queryJSONObject(e,"_collaboration._config.mediaConfiguration.voipConfigurationVideo.konvaSharingDebugMode")||!1};this._setConfig(e),this.start(i)}.bind(this)),e.addOnContentSharingEndedCallback(function(e,t){this.stop()}.bind(this)),e.addOnContentSharingPausedCallback(function(e,t){this.pause()}.bind(this)),e.addOnContentSharingResumedCallback(function(e,t){this.unpause()}.bind(this)),e.addOnFrameReceivedCallback(function(e,t){this.drawFrame(t)}.bind(this)),e.addOnFrameChangedCallback(function(e,t){this.drawFrame(t)}.bind(this))},showCursor:function(e){},start:function(){},stop:function(){},pause:function(){},unpause:function(){},drawFrame:function(e){},onOverloaded:function(e){},performanceMonitorStart:function(){},performanceMonitorStop:function(){}},n.Renderer.ContentSharingRenderer=e}(AvayaClientServices),function(s){"use strict";function e(){this._tabVisibilityEventName=_,this._tabVisibilityStateName=_,this._tabVisibilityEventName=s.Base.Utils.getBrowserTabVisibilityParams()[0],this._tabVisibilityStateName=s.Base.Utils.getBrowserTabVisibilityParams()[1],this._state=s.Renderer.Konva.KonvaContentSharingState.STOPPED,this._width=0,this._height=0,this._cursor=_,Konva.pixelRatio=1,this._zoomLayer=new Konva.FastLayer,this._cursorLayer=new Konva.FastLayer,this._pauseLayer=new Konva.FastLayer,this._zoomStage=_,this._screenSharingBg=_,this._scale=1,this._screenSharingSession=0,this._htmlCanvas=_,this._currentFrame=_,this._queuedFrames=[],this._performanceMonitor=_}(e.prototype=Object.create(s.Renderer.ContentSharingRenderer.prototype))._handleVisibilityChange=function(){!s.Base.Utils.isApplicationTabActive(this._tabVisibilityStateName)||this._performanceMonitor||this._isContentSharingStopped()?this.performanceMonitorStop():this.performanceMonitorStart()},e.prototype.getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e.prototype.drawFrame=function(e){if(!this._isContentSharingStopped()){var t=function(){var e;this._currentFrame=_,0<this._queuedFrames.length&&(e=this._queuedFrames.shift(),s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"De-queuing a "+(e.isKeyFrame()?"key":"intra")+" frame for rendering. "),this.drawFrame(e))}.bind(this);if(this._currentFrame)e.isKeyFrame()?(s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Queuing a key frame for rendering and wiping the queue of "+this._queuedFrames.length+" frames. "),this._queuedFrames=[e]):(this._queuedFrames.push(e),s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Queued an intra frame for rendering.  Queue size: "+this._queuedFrames.length));else try{this._currentFrame=e,s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Drawing a "+(e.isKeyFrame()?"key":"intra")+" frame. "),this._width!==e.getWidth()&&0<e.getWidth()&&(this._zoomStage.setWidth(e.getWidth()*this._scale),this._width=e.getWidth(),this._htmlCanvas.width=this._width,this._state===s.Renderer.Konva.KonvaContentSharingState.PAUSED&&(s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Drawing a paused layer "),this._redrawPauseLayer())),this._height!==e.getHeight()&&0<e.getHeight()&&(this._zoomStage.setHeight(e.getHeight()*this._scale),this._height=e.getHeight(),this._htmlCanvas.height=this._height,this._state===s.Renderer.Konva.KonvaContentSharingState.PAUSED&&(s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Drawing a paused layer "),this._redrawPauseLayer()));var n=this._screenSharingSession,i=e.getBitmaps().map(this._generateImage.bind(this));0<i.length?u.when.apply(this,i).then(function(){var i=arguments;Object.keys(i).forEach(function(e){var t=i[e];if(s.Base.Utils.isDefined(t))try{this._canvasContext&&n===this._screenSharingSession?this._canvasContext.drawImage(t.image,t.bitmap.getXOffset(),t.bitmap.getYOffset()):s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Skip draw image because sharing has stopped or changed")}catch(e){s.Base.Logger.error(s.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Error while processing loaded image. ",e)}finally{window.URL.revokeObjectURL(t.image.src)}else s.Base.Logger.warn(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Item is not defined")}.bind(this)),this._drawReceivedFrame(n),t()}.bind(this)).catch(function(e){s.Base.Logger.error(s.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Error while resolving array of promises of generated images ",e),t()}):(s.Base.Logger.warn(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"No images in frames were found"),t())}catch(e){s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Error when drawing a frame: "+e),t()}}},e.prototype._drawReceivedFrame=function(e){this._isContentSharingStopped()?s.Base.Logger.warn(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Content sharing was stopped. Stop drawing received frame"):this._screenSharingSession===e?(s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Drawing received frame. "),e=this._getImageFromCanvas(this._htmlCanvas),this._zoomLayer.removeChildren(),this._zoomLayer.add(e),this._zoomLayer.draw()):s.Base.Logger.warn(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Incorrect screen sharing session id. Stop drawing received frame")},e.prototype._getImageFromCanvas=function(e){return new Konva.Image({x:0,y:0,image:e})},e.prototype._isContentSharingStopped=function(){return this._state===s.Renderer.Konva.KonvaContentSharingState.STOPPED},e.prototype._generateImage=function(t){function i(){s.Base.Logger.warn(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"An image failed to load."),n.resolve(),window.URL.revokeObjectURL(a.src)}var n=u.Deferred(),a=new Image,o=this._screenSharingSession,e=function(){var e;this._config&&this._config.konvaSharingDebugMode?(e=u.Deferred(),setTimeout(function(){e.resolve()},2e3),e.promise().then(function(){o===this._screenSharingSession&&this._canvasContext?n.resolve({bitmap:t,image:a}):(window.URL.revokeObjectURL(a.src),s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Ignoring an image that loaded after its sharing session ended."),n.resolve())}.bind(this))):o===this._screenSharingSession&&this._canvasContext?n.resolve({bitmap:t,image:a}):(window.URL.revokeObjectURL(a.src),s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Ignoring an image that loaded after its sharing session ended."),n.resolve())}.bind(this),r=setTimeout(function(){s.Base.Logger.debug(s.Renderer.LoggerTags.KonvaContentSharingRenderer,"Methods did not work, horizontal pixel offset: ",t.getXOffset()),s.Base.Logger.debug(s.Renderer.LoggerTags.KonvaContentSharingRenderer,"Methods did not work, vertical pixel offset: ",t.getYOffset()),s.Base.Logger.debug(s.Renderer.LoggerTags.KonvaContentSharingRenderer,"Methods did not work, encoded base64 bitmap data: ",t.getBase64BitmapData()),s.Base.Logger.debug(s.Renderer.LoggerTags.KonvaContentSharingRenderer,"Methods did not work, bitmap width: ",t.getWidth()),s.Base.Logger.debug(s.Renderer.LoggerTags.KonvaContentSharingRenderer,"Methods did not work, bitmap height: ",t.getHeight()),a.onload=a.onerror=a.onabort=function(){};try{e()}catch(e){i()}},12e4);return a.onload=function(){e(),clearTimeout(r)},a.onerror=a.onabort=function(){i(),clearTimeout(r)},a.src=t.getBlobData(),n.promise()},e.prototype._setConfig=function(e){this._config=e},e.prototype.showCursor=function(e){var t;this._isContentSharingStopped()||(t=new Konva.Tween({node:this._cursor,duration:.1,easing:Konva.Easings.EaseIn,x:e.getX(),y:e.getY(),onFinish:function(){t.destroy()}})).play()},e.prototype.stop=function(){s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing stopped. Sharing SessionId: "+this._screenSharingSession),this._queuedFrames=[],this._htmlCanvas=_,this._canvasContext=_,this._zoomLayer.destroyChildren(),this._cursorLayer.destroyChildren(),this._pauseLayer.destroyChildren(),this._width=0,this._height=0,this._zoomStage&&(this._zoomStage.destroyChildren(),this._zoomStage.setWidth(0),this._zoomStage.setHeight(0),this._zoomStage.draw(),this._zoomStage.destroy(),this._zoomStage=_),u(this._screenSharingBg).remove(),this._screenSharingBg=_,document.removeEventListener(this._tabVisibilityEventName,this._handleVisibilityChange.bind(this),!1),this.performanceMonitorStop(),this._config=_,this._state=s.Renderer.Konva.KonvaContentSharingState.STOPPED},e.prototype.start=function(e){var t;this._isContentSharingStopped()?(s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing started."),(t=document.createElement("div")).setAttribute("id",e+"-bg"),t.classList.add("hide"),this._screenSharingBg=t,u("#"+e).parent().append(t),this._zoomStage=new Konva.Stage({container:e,width:this._width,height:this._height}),this._zoomStage.scale({x:this._scale,y:this._scale}),this._zoomStage.add(this._zoomLayer),this._zoomStage.add(this._cursorLayer),this._zoomStage.add(this._pauseLayer),this._htmlCanvas=document.createElement("canvas"),this._htmlCanvas.width=this._width,this._htmlCanvas.height=this._height,this._canvasContext=this._htmlCanvas.getContext("2d"),this._cursor=new Konva.Circle({x:-10,y:-10,radius:5,fill:"#EF5353"}),this._cursorLayer.add(this._cursor),this._state=s.Renderer.Konva.KonvaContentSharingState.STARTED,this._zoomLayer.destroyChildren(),this._zoomStage.draw()):s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing re-started. ",this._state),setTimeout(function(){this._isContentSharingStopped()||this.performanceMonitorStart()}.bind(this),1e3*this._config.konvaSharingGracePeriod),void 0===document.addEventListener||this._tabVisibilityStateName===_?s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Page Visibility API is not supported by this browser."):document.addEventListener(this._tabVisibilityEventName,this._handleVisibilityChange.bind(this),!1),this._screenSharingSession=this._screenSharingSession<1e4?this._screenSharingSession+1:0,s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Sharing SessionId: "+this._screenSharingSession)},e.prototype.pause=function(){s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing paused."),this._state=s.Renderer.Konva.KonvaContentSharingState.PAUSED,0<this._width?this._redrawPauseLayer():this._contentSharing.isSharingApplicationWindow()||this._contentSharing.isSharingFullScreen()||this._contentSharing.isSharingApplicationWindow()===_||(this._width=800,this._height=600,this._zoomStage.setWidth(this._width*this._scale),this._zoomStage.setHeight(this._height*this._scale),this._redrawPauseLayer())},e.prototype._redrawPauseLayer=function(){this._pauseLayer.removeChildren();var e=new Konva.Rect({x:0,y:0,opacity:.1,width:this._width,height:this._height,fill:"#00897b"});this._pauseLayer.add(e);e=new Konva.Rect({x:this._width/2-20-10,y:(this._height-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(e);e=new Konva.Rect({x:this._width/2+10,y:(this._height-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(e),this._zoomStage.draw()},e.prototype.unpause=function(){s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Screen sharing un-paused."),this._state=s.Renderer.Konva.KonvaContentSharingState.STARTED,this._pauseLayer.removeChildren(),this._zoomStage.draw()},e.prototype.zoom=function(e){if(!this._isContentSharingStopped()){if(e<=0)throw new Error("Scale cannot be lower than 0.");e>=Number.POSITIVE_INFINITY||(this._scale=e,this._zoomStage.height(this._height*this._scale),this._zoomStage.width(this._width*this._scale),this._zoomStage.scale({x:this._scale,y:this._scale}),this._zoomStage.draw())}},e.prototype.autoFit=function(e,t){return s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Updating autofit to width: "+e+" height: "+t),e=this._width*t/this._height<e?t/this._height:e/this._width,this.zoom(e),e},e.prototype._saveFrameToDisk=function(e){var e=e.getBitmaps(),i=1,n=new JSZip;e.forEach(function(e){var t=0===e._imageType?"jpeg":"png",t=i+++"_"+e.getXOffset()+"_"+e.getYOffset()+"_"+e.getWidth()+"_"+e.getHeight()+"."+t;n.file(t,e.getRawBitmapData(),{base64:!0})}),n.generateAsync({type:"blob"}).then(function(e){saveAs(e,"download.zip")})},e.prototype.performanceMonitorStart=function(){var i=0,n=[],a=0,o=this._config,r=o.konvaSharingMeasurementsWindowDuration/o.konvaSharingMeasurementsInterval;s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Starting counting frames averages."),this._performanceMonitor=setInterval(function(){var e,t=this._queuedFrames.length;a++,i+=t,n.push(t),r<a&&(e=n.shift(),i-=e),r<=a&&(e=i/r,!0===o.konvaSharingDebugMode&&s.Base.Logger.debug(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Counting frames averages, current step: "+a+", frames averages: "+e),t>o.konvaSharingFramesWarningLimit&&this._contentSharing._notifyPerformanceMonitorAlert(s.Base.PerformanceAlertType.CPU_USAGE_WARNING),e>o.konvaSharingFramesAverageLimit&&(e="Average frames queued is "+e,this._contentSharing._notifyPerformanceMonitorAlert(s.Base.PerformanceAlertType.CPU_USAGE_OVERLOADED,e)))}.bind(this),1e3*o.konvaSharingMeasurementsInterval)},e.prototype.performanceMonitorStop=function(){this._performanceMonitor&&(clearInterval(this._performanceMonitor),this._performanceMonitor=_,s.Base.Logger.info(s.Renderer.LoggerTags.KONVA_CONTENT_SHARING_RENDERER,"Konva Renderer performance monitor was stopped."))},s.Renderer.Konva.KonvaContentSharingRenderer=e}(AvayaClientServices),function(){"use strict";AvayaClientServices.Renderer.Konva.KonvaContentSharingState={STARTED:"STARTED",STOPPED:"STOPPED",PAUSED:"PAUSED"}}(),function(){"use strict";function e(){}e.prototype={convertRectangle:function(e){var t=!!e.attrs.fill,i=this._colorHexToInt(t?e.attrs.fill:e.attrs.stroke),n=e.attrs.strokeWidth||0,n=new AvayaClientServices.Services.Collaboration.Shape("",t,!0,i,void 0,n);return n.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x,e.attrs.y)),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x+e.attrs.width,e.attrs.y)),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x+e.attrs.width,e.attrs.y+e.attrs.height)),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x,e.attrs.y+e.attrs.height)),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x,e.attrs.y)),n.finishDrawing(),n},convertEllipse:function(e){var t=new AvayaClientServices.Services.Collaboration.Point(e.attrs.x-e.attrs.radiusX,e.attrs.y-e.attrs.radiusY),i=new AvayaClientServices.Services.Collaboration.Point(e.attrs.x+e.attrs.radiusX,e.attrs.y+e.attrs.radiusY),n=!!e.attrs.fill,a=this._colorHexToInt(n?e.attrs.fill:e.attrs.stroke),e=e.attrs.strokeWidth||0;return new AvayaClientServices.Services.Collaboration.Circle(t,i,"",n,!0,a,void 0,e)},convertText:function(e){var t=e.attrs.text,i=e.attrs.fontSize,n=this._colorHexToInt(e.attrs.fill),n=new AvayaClientServices.Services.Collaboration.WhiteboardText(t,i,"",!0,!0,n);return n.setPosition(new AvayaClientServices.Services.Collaboration.Point(e.attrs.x,e.attrs.y)),n},convertLine:function(e){var t=this._colorHexToInt(e.attrs.stroke),i=e.attrs.strokeWidth||0,i=new AvayaClientServices.Services.Collaboration.Shape("",!1,!0,t,void 0,i);return i.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.points[0],e.attrs.points[1])),i.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e.attrs.points[2],e.attrs.points[3])),i.finishDrawing(),i},convertPolygon:function(e,t){var i=!!e.attrs.fill,n=this._colorHexToInt(i?e.attrs.fill:e.attrs.stroke),a=e.attrs.strokeWidth||0,o=100*e.attrs.opacity,r=new AvayaClientServices.Services.Collaboration.Shape("",i,!0,n,o,a);r.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(e._modelStart.x,e._modelStart.y));for(var s=0;s<e._modelRelativePoints.length;s++){var h=e._modelRelativePoints[s];0!==h.x&&0!==h.y&&r.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(e._modelStart.x+h.x,e._modelStart.y+h.y))}return t&&r.finishDrawing(),r},_colorHexToInt:function(e){return"#"===e[0]?parseInt("0x".concat(e.slice(1))):parseInt("0x".concat(e))}},AvayaClientServices.Renderer.Konva.KonvaWhiteboardConverter=e}(),function(r){"use strict";function e(){r.Services.Collaboration.WhiteboardRenderer.call(this),this._width=800,this._height=600,this._scale=1,this._drawingStage=_,this._drawingLayer=_,this._canvas=_,this._mode=r.Services.Collaboration.WhiteboardToolModes.STROKE,this._color="#211e1e",this._strokeWidth=6,this._whiteboardConverter=new r.Renderer.Konva.KonvaWhiteboardConverter,this._whiteboardTools=new r.Renderer.Konva.KonvaWhiteboardTools(this),this._tool=this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],this._isDrawing=!1,this._fontSize=19,this._annotatedShape=_,this._inputExists=!1,this._curWin=window,this._textAreaData=_}(e.prototype=Object.create(r.Services.Collaboration.WhiteboardRenderer.prototype)).getWidth=function(){return this._width},e.prototype.getHeight=function(){return this._height},e.prototype.start=function(e){this._setupWhiteboard(e),this._canvas=document.getElementById(e).getElementsByClassName("konvajs-content")[0].getElementsByTagName("canvas")[0],this._canvas.onmousedown=function(e){if(!this._whiteboard.getDrawingCapability().isAllowed)return r.Base.Logger.warn(r.Base.LoggerTags.COLLABORATION_SERVICE,"It is not possible to use any whiteboard tool since whiteboard is not available at the moment."),!1;switch(this._tool.type){case r.Services.Collaboration.WhiteboardToolTypes.SELECTION:return;case r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE:case r.Services.Collaboration.WhiteboardToolTypes.CIRCLE:return void this._dragTool(e);case r.Services.Collaboration.WhiteboardToolTypes.MARKER:case r.Services.Collaboration.WhiteboardToolTypes.PEN:return void this._liveTool(e);case r.Services.Collaboration.WhiteboardToolTypes.LINE:return void this._dragTool(e);case r.Services.Collaboration.WhiteboardToolTypes.STAMP:return void this._stampTool(e);case r.Services.Collaboration.WhiteboardToolTypes.TEXT:return void this._textTool(e);case r.Services.Collaboration.WhiteboardToolTypes.DELETE:return void this._deleteShape(e);case r.Services.Collaboration.WhiteboardToolTypes.CLEAR:return}}.bind(this)},e.prototype.end=function(e){this._drawingLayer&&(this._canvas.onmousedown=_,this._drawingLayer.destroyChildren(),this._drawingStage.destroyChildren(),this._drawingLayer.destroy(),this._drawingStage.destroy(),document.getElementById(e).innerHTML="",this._drawingLayer=_,this._drawingStage=_)},e.prototype.drawShape=function(t){var e;if(this._drawingLayer)if(this._drawingLayer.children.filter(function(e){return e.id===t.getId()}).length){var i=this._whiteboard.getActiveSurface().getShapes()[t.getId()];r.Base.Utils.isDefined(i._ownerDisplayName)&&""!==i._ownerDisplayName||(i._ownerDisplayName=t.getOwnerDisplayName())}else{if(t instanceof r.Services.Collaboration.Shape)e=this._createShape(t);else if(t instanceof r.Services.Collaboration.Circle)e=this._createCircle(t);else{if(!(t instanceof r.Services.Collaboration.WhiteboardText))return;e=this._createText(t)}this._drawingLayer.add(e),this._drawingLayer.draw()}},e.prototype.removeShape=function(e){e=this._getKonvaShape(e);e&&(e.destroy(),this._drawingLayer.draw())},e.prototype._deleteShape=function(e){e=this._drawingLayer.getIntersection({x:e.offsetX,y:e.offsetY});if(null!==e){var t=this._getSDKShape(e);if(t.isMine())return this.removeShape(t),this._whiteboard.getActiveSurface().removeShape(t)}t=u.Deferred();return t.reject(),t.promise()},e.prototype.updateShape=function(n){var e,t,a=this._getKonvaShape(n);a&&n.getId()!==a.id&&(a.id=n.getId()),a instanceof Konva.Ellipse&&r.Base.Utils.isDefined(n.getTranslation())?(e=a.initX+n.getTranslation().getX(),t=a.initY+n.getTranslation().getY()):a instanceof Konva.Text&&r.Base.Utils.isDefined(n.getPosition())?(e=n.getPosition().getX()+n.getTranslation().getX(),t=n.getPosition().getY()+n.getTranslation().getY()):a instanceof Konva.Shape&&(r.Base.Utils.isDefined(n.getTranslation())?t=a instanceof Konva.Rect?(e=n.getPoints()[0].point.getX()+n.getTranslation().getX(),n.getPoints()[0].point.getY()+n.getTranslation().getY()):(e=n.getTranslation().getX(),n.getTranslation().getY()):a.attrs.sceneFunc=function(e){e.beginPath();for(var t=n.getPoints(),i=0;i<t.length;i++)t[i].isMove?e.moveTo(t[i].point.getX(),t[i].point.getY()):e.lineTo(t[i].point.getX(),t[i].point.getY());e.fillStrokeShape(a)}.bind(this)),r.Base.Utils.isDefined(e)&&r.Base.Utils.isDefined(t)&&a.position({x:e,y:t}),this._drawingLayer.draw()},e.prototype.clearContent=function(){if(r.Base.Utils.isDefined(this._drawingLayer)){for(var e=this._drawingLayer.children.length-1;0<=e;e--)this._drawingLayer.children[e].destroy();this._drawingLayer.draw()}},e.prototype.setTool=function(e,t){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Tool set: ",e,t),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._drawingLayer&&this._unsetDraggable(),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.TEXT&&this._destructTextTool(),this._tool=this._whiteboardTools[e],t&&this._tool.modes[t]&&(this._mode=t),r.Base.Utils.isDefined(this._canvas)&&e!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&e!==r.Services.Collaboration.WhiteboardToolTypes.DELETE&&(this._canvas.onmousemove=_,this._canvas.onmouseout=_,r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=_)),!r.Base.Utils.isDefined(this._canvas)||e!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&e!==r.Services.Collaboration.WhiteboardToolTypes.DELETE||(this._canvas.onmousemove=function(e){var t=this._drawingLayer.getIntersection({x:e.offsetX,y:e.offsetY});null!==t&&!r.Base.Utils.isDefined(this._annotatedShape)||null!==t&&r.Base.Utils.isDefined(this._annotatedShape)&&t._id!==this._annotatedShape._id?(e=this._getSDKShape(t),this._onShowShapeAnnotationCallbacks.fire(e),this._annotatedShape=t):null===t&&r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=_)}.bind(this),this._canvas.onmouseout=function(e){r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=_)}.bind(this)),e===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._setDraggable(),e===r.Services.Collaboration.WhiteboardToolTypes.CLEAR&&this._clear()},e.prototype._destructTextTool=function(){var e=this._canvas.parentNode.querySelector("#"+this._getTextInputId());e&&(e.value?this._renderText(_,e):e.parentNode.removeChild(e),this._textAreaData=_)},e.prototype._getTextInputId=function(){return this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.TEXT]._getElementId()},e.prototype._renderText=function(e,t){t=this._tool.endInput(e,this._canvas,t,this._scale);t.fill(this._color),t.fontSize(r.Services.Collaboration.WhiteboardTextSizes[this._mode]),t.fontStyle("bold"),this._drawingLayer.add(t),this._drawingLayer.draw(),this._convertAndAddShape(t,this._tool.name)},e.prototype.setColor=function(e){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Color set: ",e),this._color=e},e.prototype.zoom=function(e){if(e<=0)throw new Error("Scale cannot be lower than 0.");e>=Number.POSITIVE_INFINITY||(this._scale=e,this._drawingLayer.scale({x:this._scale,y:this._scale}),this._drawingLayer.draw(),this._drawingStage.height(this._height*this._scale),this._drawingStage.width(this._width*this._scale),this._zoomTool())},e.prototype._zoomTool=function(){var e;this._tool.type!==r.Services.Collaboration.WhiteboardToolTypes.TEXT||!this._canvas.parentNode||(e=this._canvas.parentNode.querySelector("#"+this._getTextInputId()))&&this._textAreaData.textTool._zoom(e,this._textAreaData,this._canvas,this._mode,this._scale)},e.prototype.resubscribeWinEvents=function(){var e=this._canvas.ownerDocument.defaultView;e&&this._curWin!==e&&(Konva.DD._endDragBefore&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragBefore,!0),this._curWin.removeEventListener("touchend",Konva.DD._endDragBefore,!0),e.addEventListener("mouseup",Konva.DD._endDragBefore,!0),e.addEventListener("touchend",Konva.DD._endDragBefore,!0)),Konva.DD._drag&&(this._curWin.removeEventListener("mousemove",Konva.DD._drag),this._curWin.removeEventListener("touchmove",Konva.DD._drag),e.addEventListener("mousemove",Konva.DD._drag),e.addEventListener("touchmove",Konva.DD._drag)),Konva.DD._endDragAfter&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragAfter,!1),this._curWin.removeEventListener("touchend",Konva.DD._endDragAfter,!1),e.addEventListener("mouseup",Konva.DD._endDragAfter,!1),e.addEventListener("touchend",Konva.DD._endDragAfter,!1)),this._drawingStage&&this._drawingStage._bindContentEvents&&this._drawingStage._bindContentEvents(),this._curWin=e)},e.prototype.autoFit=function(e,t){e=this._width*t/this._height<e?t/this._height:e/this._width;return this.zoom(e),e},e.prototype._textTool=function(e){var t=this._canvas.parentNode.querySelector("#"+this._getTextInputId());t?this._inputExists&&this._renderText(e,t):(this._textAreaData=this._tool.startInput(e,this._canvas,this._mode,this._scale),this._inputExists=!0)},e.prototype._dragTool=function(e){this._isDrawing=!0;var t=this._tool.startFunction(e,this._mode,this._scale),i=function(e){this._isDrawing=!1,this._tool.endFunction(e),this._clearMouseEvents(),t.isMine=!0,this._convertAndAddShape(t,this._tool.name)}.bind(this);this._canvas.onmouseup=function(e){i(e)}.bind(this),this._canvas.onmouseleave=function(e){i(e)}.bind(this)},e.prototype._liveTool=function(e){this._isDrawing=!0;var t,i,n=this._tool.startFunction(e,this._scale),a=this._whiteboardConverter.convertPolygon(n,!1);var o=function(e){this._isDrawing=!1,this._tool.endFunction(e),this._clearMouseEvents(),n.isMine=!0,a.isFinished()||(i&&a.addLinePoint(i),a.finishDrawing().done(function(e){this._updateShapeId(n,e)}.bind(this)))}.bind(this);return this._canvas.onmousemove=function(e){this._tool.drawFunction(e,n),i=new r.Services.Collaboration.Point(e.offsetX/this._scale,e.offsetY/this._scale);e=a.getPoints()[a.getPoints().length-1];t&&!function(e,t,i){var n={};n.gradient=(e.point.getY()-t.point.getY())/(e.point.getX()-t.point.getX()),n.interceptY=e.point.getY()-n.gradient*e.point.getX();var a=i.point.getY()===n.gradient*i.point.getX()+n.interceptY,i=e.point.getX()===t.point.getX()&&t.point.getX()===i.point.getX()||e.point.getY()===t.point.getY()&&t.point.getY()===i.point.getY();return a&&(1===n.gradient||-1===n.gradient)||i}(e,t,{point:i})&&a.addLinePoint(t.point),t={point:i}}.bind(this),this._canvas.onmouseup=function(e){o(e)}.bind(this),this._canvas.onmouseleave=function(e){o(e)}.bind(this),this._whiteboard.getActiveSurface().addShape(a).done(function(e){this._updateShapeId(n,e)}.bind(this))},e.prototype._stampTool=function(e){this._isDrawing=!0,(e=this._tool.drawFunction(e,this._scale)).isMine=!0,this._isDrawing=!1,this._convertAndAddShape(e,this._tool.name)},e.prototype._clear=function(){return this.clearContent(),this._whiteboard.getActiveSurface().clearContent()},e.prototype._createShape=function(e){var n=e.getPoints(),t=new Konva.Shape({fill:e.isFilled()?r.Base.Utils.colorIntToHex(e.getColor()):_,stroke:e.isFilled()?_:r.Base.Utils.colorIntToHex(e.getColor()),strokeWidth:e.isFilled()?_:e.getWidth(),lineCap:"round",lineJoin:"round",opacity:e.getAlpha()/100,sceneFunc:function(e){e.beginPath();for(var t,i=0;i<n.length;i++)(t=n[i]).isMove?e.moveTo(t.point.getX(),t.point.getY()):e.lineTo(t.point.getX()+.1,t.point.getY()+.1);e.fillStrokeShape(this)}});return r.Base.Utils.isDefined(e.getTranslation())&&t.position({x:e.getTranslation().getX(),y:e.getTranslation().getY()}),this._addCommonData(e,t)},e.prototype._moveShape=function(e,t){var i=this._getSDKShape(e),n=t.newPositionX-t.selectionX,e=t.newPositionY-t.selectionY,t=i.getTranslation();r.Base.Utils.isDefined(t)?i.setTranslation(new r.Services.Collaboration.Point(t.getX()+n,t.getY()+e)):i.setTranslation(new r.Services.Collaboration.Point(n,e)),this._whiteboard.getActiveSurface().updateShape(i)},e.prototype._createCircle=function(e){var t=new Konva.Ellipse({x:e.getTopLeft().getX()+(e.getBottomRight().getX()-e.getTopLeft().getX())/2,y:e.getTopLeft().getY()+(e.getBottomRight().getY()-e.getTopLeft().getY())/2,radius:{x:(e.getBottomRight().getX()-e.getTopLeft().getX())/2,y:(e.getBottomRight().getY()-e.getTopLeft().getY())/2},fill:e.isFilled()?r.Base.Utils.colorIntToHex(e.getColor()):_,stroke:e.isFilled()?_:r.Base.Utils.colorIntToHex(e.getColor()),strokeWidth:e.isFilled()?_:e.getWidth()});return t.initX=t.attrs.x,t.initY=t.attrs.y,r.Base.Utils.isDefined(e.getTranslation())&&t.position({x:t.initX+e.getTranslation().getX(),y:t.initY+e.getTranslation().getY()}),this._addCommonData(e,t)},e.prototype._createText=function(e){var t=new Konva.Text({x:e.getPosition().getX(),y:e.getPosition().getY(),fill:r.Base.Utils.colorIntToHex(e.getColor()),text:e.getContent(),fontSize:e.getFontSize(),fontFamily:"Arial",fontStyle:"bold",lineHeight:1.25});return r.Base.Utils.isDefined(e.getTranslation())&&t.position({x:e.getPosition().getX()+e.getTranslation().getX(),y:e.getPosition().getY()+e.getTranslation().getY()}),this._addCommonData(e,t)},e.prototype._addCommonData=function(e,t){return t.id=e.getId(),t.ownerDisplayName=e.getOwnerDisplayName(),t.status=e.getStatus(),t.isMine=e.isMine(),t},e.prototype._setupWhiteboard=function(e){this._drawingStage&&this.end(e),this._drawingStage=new Konva.Stage({container:e,width:this._width,height:this._height}),this._drawingLayer=new Konva.Layer,this._drawingStage.add(this._drawingLayer),this.zoom(this._scale)},e.prototype._convertAndAddShape=function(t){if(t instanceof Konva.Rect)return e=this._whiteboardConverter.convertRectangle(t),this._whiteboard.getActiveSurface().addShape(e).done(function(e){this._updateShapeId(t,e)}.bind(this));if(t instanceof Konva.Ellipse)return e=this._whiteboardConverter.convertEllipse(t),this._whiteboard.getActiveSurface().addCircle(e).done(function(e){this._updateShapeId(t,e)}.bind(this));if(t instanceof Konva.Line)return e=this._whiteboardConverter.convertLine(t),this._whiteboard.getActiveSurface().addShape(e).done(function(e){this._updateShapeId(t,e)}.bind(this));if(t instanceof Konva.Text)return e=this._whiteboardConverter.convertText(t),this._whiteboard.getActiveSurface().addText(e).done(function(e){this._updateShapeId(t,e)}.bind(this));if(t instanceof Konva.Shape){var e=this._whiteboardConverter.convertPolygon(t,!0);return this._whiteboard.getActiveSurface().addShape(e).done(function(e){this._updateShapeId(t,e)}.bind(this))}},e.prototype._getKonvaShape=function(e){if(this._drawingLayer&&this._drawingLayer.children)for(var t=0;t<this._drawingLayer.children.length;t++)if(this._drawingLayer.children[t].id===e.getId()||this._drawingLayer.children[t].id===e._tempId)return this._drawingLayer.children[t]},e.prototype._getSDKShape=function(e){return this._whiteboard.getActiveSurface().getShapes()[e.id]},e.prototype._updateShapeId=function(e,t){e.id=t},e.prototype._setDraggable=function(){for(var e=this._drawingLayer.children,t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!0);this._drawingLayer.on("dragstart",function(e){this._tool.dragStart(e,this._scale);var t=e.target,e=t.getSelfRect(),i={x:e.x*this._scale,y:e.y*this._scale,width:e.width*this._scale,height:e.height*this._scale},n=null;t.dragBoundFunction&&t.setDragBoundFunc(function(e){n=n||e;e=t.dragBoundFunction(t,e,i,this._canvas.getBoundingClientRect(),n,this._scale);return n=e}.bind(this))}.bind(this)),this._drawingLayer.on("dragend",function(e){var t=e.target;this._tool.dragEnd(e,this._scale),t.setDragBoundFunc()}.bind(this)),this._drawingLayer.draw()},e.prototype._unsetDraggable=function(){for(var e=this._drawingLayer.children,t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!1);this._drawingLayer.off("dragstart"),this._drawingLayer.off("dragend"),this._drawingLayer.draw()},e.prototype._clearMouseEvents=function(){this._canvas.onmouseup=_,this._canvas.onmouseleave=_},r.Renderer.Konva.KonvaWhiteboardRenderer=e}(AvayaClientServices),function(){"use strict";function e(l){AvayaClientServices.Services.Collaboration.WhiteboardTools.call(this);function a(e,t,i,n,a,o){var r=0-.9*i.width,s=n.width-i.width*(1-.9),h=0-.9*i.height,i=n.height-i.height*(1-.9);return{x:Math.min(s,Math.max(r,t.x)),y:Math.min(i,Math.max(h,t.y))}}function s(e,t,i,n,a,o){var r=i.width-.9*i.width-i.width/2,s=i.height-.9*i.height-i.height/2,h=n.width-r,d=s,i=n.height-s,i={x:Math.min(h,Math.max(r,t.x)),y:Math.min(i,Math.max(d,t.y))};return(t.x<0||t.x>n.width)&&(t.y<0||t.y>n.height)&&(d={x:0,y:0},t.x<0?d.x=0:d.x=n.width,t.y<0?d.y=0:d.y=n.height,Math.min(r,s)<Math.sqrt(Math.pow(t.x-d.x,2)+Math.pow(t.y-d.y,2))&&(i=a)),i}function g(e,t,i,n){for(var a=0,o=0,r=e._modelRelativePoints,s=r.length<=5?2:5;o<r.length&&a<s;){var h=r[o].x/e._originalScale*n+t.x,d=r[o].y/e._originalScale*n+t.y;0<h&&h<i.width&&0<d&&d<i.height&&a++,o++}return a<s}function c(e,t,i,n){for(var a={x:e.getPoints()[0]*n+t.x,y:e.getPoints()[1]*n+t.y},o={x:e.getPoints()[2]*n+t.x,y:e.getPoints()[3]*n+t.y},r=0,s=0,s=(r=a.x,o.x),h=0;r<s&&h<5;){var d=(o.y-a.y)/(o.x-a.x)*(r-a.x)+a.y;0<r&&r<i.width&&0<d&&d<i.height&&h++,r+=4}return h<5}function h(e,t,i,n,a,o){var r=e instanceof Konva.Text?.54:.9,s=e instanceof Konva.Text?.765:.9,h=-i.x-i.width*s,d=n.width-(i.x+i.width*(1-s)),s=-i.y-i.height*r,r=n.height-(i.y+i.height*(1-r)),r={x:Math.min(d,Math.max(h,t.x)),y:Math.min(r,Math.max(s,t.y))},s=t.x<-i.x||t.x>n.width-i.x-i.width;return r=t.y<-i.y||t.y>n.height-i.y-i.height||s?function(e,t,i,n,a,o){var r;if(e._modelRelativePoints){if(e._shapeType&&"Stamp"===e._shapeType)return o;r=g}else{if(!(e instanceof Konva.Line))return o;r=c}if(r(e,t,i,n)){var s={x:t.x,y:a.y};if(r(e,s,i,n)){t={x:a.x,y:t.y};return r(e,t,i,n)?a:t}return s}return o}(e,t,n,o,a,r):r}var e=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.LINE],t=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],i=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.CIRCLE],n=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.STAMP],o=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.SELECTION],y=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.TEXT],r=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.MARKER],d=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.PEN];r.startFunction=function(e,i){var n=new Konva.Shape({stroke:l._color,strokeWidth:12,hitStrokeWidth:20,lineCap:"round",lineJoin:"round",opacity:.6,sceneFunc:function(e){e.beginPath();var t=0;for(e.moveTo(n._modelStart.x,n._modelStart.y);t<n._modelRelativePoints.length;t++)e.lineTo(n._modelRelativePoints[t].x/i,n._modelRelativePoints[t].y/i);e.fillStrokeShape(this)}});return n.setDragDistance(0),n.dragBoundFunction=h,n._modelStart={x:e.offsetX/i,y:e.offsetY/i},n._modelRelativePoints=[],n._originalScale=i,n._selfRectCoordinates={minX:999999,minY:999999,maxX:-999999,maxY:-999999},n.getSelfRect=function(){return{x:this._selfRectCoordinates.minX/i,y:this._selfRectCoordinates.minY/i,width:this._selfRectCoordinates.maxX/i-this._selfRectCoordinates.minX/i,height:this._selfRectCoordinates.maxY/i-this._selfRectCoordinates.minY/i}},l._drawingLayer.add(n),l._drawingLayer.draw(),n}.bind(this),r.drawFunction=function(e,t){t._modelRelativePoints.push({x:e.offsetX,y:e.offsetY}),t._selfRectCoordinates.minX=Math.min(t._selfRectCoordinates.minX,e.offsetX),t._selfRectCoordinates.minY=Math.min(t._selfRectCoordinates.minY,e.offsetY),t._selfRectCoordinates.maxX=Math.max(t._selfRectCoordinates.maxX,e.offsetX),t._selfRectCoordinates.maxY=Math.max(t._selfRectCoordinates.maxY,e.offsetY),l._drawingLayer.draw(),l._drawingStage.draw()},r.endFunction=function(){l._canvas.onmousemove=_}.bind(this),d.startFunction=function(e,i){var n=new Konva.Shape({stroke:l._color,strokeWidth:4,hitStrokeWidth:20,lineCap:"round",lineJoin:"round",opacity:1,sceneFunc:function(e){e.beginPath();var t=0;for(e.moveTo(n._modelStart.x,n._modelStart.y);t<n._modelRelativePoints.length;t++)e.lineTo(n._modelRelativePoints[t].x/i,n._modelRelativePoints[t].y/i);e.fillStrokeShape(this)}});return n.dragBoundFunction=h,n._modelStart={x:e.offsetX/i,y:e.offsetY/i},n._modelRelativePoints=[],n._originalScale=i,n._selfRectCoordinates={minX:999999,minY:999999,maxX:-999999,maxY:-999999},n.getSelfRect=function(){return{x:this._selfRectCoordinates.minX/i,y:this._selfRectCoordinates.minY/i,width:this._selfRectCoordinates.maxX/i-this._selfRectCoordinates.minX/i,height:this._selfRectCoordinates.maxY/i-this._selfRectCoordinates.minY/i}},n.setDragDistance(0),l._drawingLayer.add(n),l._drawingLayer.draw(),n}.bind(this),d.drawFunction=function(e,t){t._modelRelativePoints.push({x:e.offsetX,y:e.offsetY}),t._selfRectCoordinates.minX=Math.min(t._selfRectCoordinates.minX,e.offsetX),t._selfRectCoordinates.minY=Math.min(t._selfRectCoordinates.minY,e.offsetY),t._selfRectCoordinates.maxX=Math.max(t._selfRectCoordinates.maxX,e.offsetX),t._selfRectCoordinates.maxY=Math.max(t._selfRectCoordinates.maxY,e.offsetY),l._drawingLayer.draw(),l._drawingStage.draw()},d.endFunction=function(){l._canvas.onmousemove=_}.bind(this),y._getElementId=function(){return"canvasTextInput"},y.endInput=function(e,t,i,n){var a,o=parseInt(i.style.fontSize.replace("px","")),r=0;getComputedStyle&&((a=parseInt(getComputedStyle(i).borderBottomWidth))&&(r+=a),(a=parseInt(getComputedStyle(i).paddingLeft))&&(r+=a));o=new Konva.Text({x:parseInt(i.style.left)/n+r,y:parseInt(i.style.top)/n,text:i.value,fontFamily:"Arial",lineHeight:1.25,fontSize:o});return o.isMine=!0,o.fontStyle("bold"),o.dragBoundFunction=h,l._inputExists=!1,i.parentNode.removeChild(i),o},y.startInput=function(e,c,t,i){var f=c.getBoundingClientRect().width,v=c.getBoundingClientRect().height,_=document.createElement("textarea"),s=20,n=1,a=e.offsetY,h=e.offsetX,p=AvayaClientServices.Services.Collaboration.WhiteboardTextSizes[t]*i,d=!1;function S(){p=parseInt(_.style.fontSize.replace("px","")),f=c.getBoundingClientRect().width,v=c.getBoundingClientRect().height}function g(e){S(),n=1,e.split("").forEach(function(e,t,i){"\n"===e&&(n+=1)}),_.setAttribute("rows",n),AvayaClientServices.Base.Utils.getBrowserType()===AvayaClientServices.Base.BrowserType.IE&&(e=_.id,(e=u("#"+e)).length&&e.height(1.32*n*p))}return _.setAttribute("id",this._getElementId()),_.setAttribute("rows",n),_.style.cssText="z-Index: 101; outline: 0; font-family: 'Arial'; font-weight:bold; font-size:"+p+"px; position: absolute; top:"+e.offsetY.toString()+"px; left:"+e.offsetX.toString()+"px; overflow: hidden; width:"+s+"px; line-height:1.32; height: auto; margin:0; border: 1px solid rgb(106, 105, 105); background: white; border-radius: 1px; margin-top: -2px; white-space: pre; color:"+l._color,c.parentNode.appendChild(_),setTimeout(function(){_.focus()}),y._checkOutOfBounds(_,c),_.addEventListener("keypress",function(e){S();var t=(h=e.target.value).length,i=e.keyCode,n=String.fromCharCode(e.keyCode),a=_.clientHeight,o=c.clientWidth;if(c.clientHeight<=a+p){if(13===i)return e.preventDefault(),!1;var r,i=e.target.selectionStart,s=0,h=h.split("");h.splice(i,0,n);for(var d=h.join(""),g=i;g<t+1;g++)if("\n"===d[g]){r=g;break}for(var l=i;0<=l;l--)if("\n"===d[l]){s=l;break}r&&(r+=1);i=d.slice(s+1,r);if(o<y._calculateWidth(i,p))return e.preventDefault(),!1}y._checkOutOfBounds(_,c)}),_.addEventListener("input",function(e){S();var t=e.target.value;3500<t.length&&(e.target.value=t.slice(0,3500),t=e.target.value);var i,n,a,o=t.length,r=e.target.value.charCodeAt(o-1);"insertFromPaste"!==e.inputType&&!d||(i=e.target.value.split("\n"),n=Math.round(v/(1.32*p)),t=function(e){S();for(var t=e.join("\n").split(""),i=0,n=Math.round(v/(1.32*p)),a=0;a<e.length;a++){var o=e[a],r=y._calculateWidth(o,p);if(f<r)for(var s=Math.ceil(r/f),h=0,d=0;d<s;d++){for(var g=o.slice(h,h+151),l=0;l<3500&&y._calculateWidth(g,p)>f;l++)g=g.substring(0,g.length-1);var c=g.split("");-1<g.indexOf(" ")&&h+g.length!==o.length?(t.splice(c.lastIndexOf(" ")+i+h,1,"\n"),h=h+c.lastIndexOf(" ")+1):h+g.length!==o.length&&(t.splice(c.length+i+h,0,"\n"),h=c.length+h)}i+=o.length+1}var _=t.join(""),u=_.split("\n");return _=u.length>n?u.slice(0,n).join("\n"):_}(i=i.length>n?i.slice(0,n):i),e.target.value=t),10!==r||"insertFromPaste"===e.inputType||d?(s=y._calculateWidth(t,p))<f?(_.style.width=s+"px",_.getBoundingClientRect().left+s>c.getBoundingClientRect().right&&(a=_.getBoundingClientRect().left+s-c.getBoundingClientRect().right,h-=a,_.style.left=h+"px"),g(e.target.value)):(_.style.left=0,_.style.width=f+"px",r=e.target.value.split("\n").slice(-1)[0],a=y._calculateWidth(r,p),r=r.indexOf(" "),t=t.split(""),f<a&&(-1<r?t.splice(t.lastIndexOf(" "),1,"\n"):t.splice(-1,0,"\n"),e.target.value=t.join(""),g(e.target.value))):1===o?e.target.value="":g(e.target.value),d=!1,y._checkOutOfBounds(_,c)}),_.addEventListener("paste",function(){d=!0}),{initialTop:a,initialLeft:h,initialCanvasHeigth:v,initialCanvasWidth:f,textTool:this}},y._calculateWidth=function(e,t){var i=document.createElement("span");i.style.cssText="font-weight:bold; top:400px; left:300px; line-height: normal; visibility:hidden; borderRadius: 1px; position: absolute; border: 1px  solid rgb(106, 105, 105); margin: 0; white-space: pre; padding:2px; display: inline-block; font-size:"+t+"px; font-family:'Arial'",i.innerHTML=e,document.body.appendChild(i);e=i.getBoundingClientRect().width;return setTimeout(function(){document.body.removeChild(i)},100),e},y._adjustWidth=function(e){var t=e.value||" ",i=parseInt(e.style.fontSize.replace("px","")),i=y._calculateWidth(t,i);e.style.width=i+"px"},y._checkOutOfBounds=function(e,t){var i=e.clientHeight,n=e.clientWidth,a=e.offsetTop,o=e.offsetLeft;i+a>t.clientHeight&&((i=t.clientHeight-i)<0&&(i=0),e.style.top=i+"px"),n+o>t.clientWidth&&((n=t.clientWidth-n)<0&&(n=0),e.style.left=n+"px")},y._zoom=function(e,t,i,n,a){var o=i.getBoundingClientRect().width,r=i.getBoundingClientRect().height*t.initialTop/t.initialCanvasHeigth;e.style.top=r+"px";t=o*t.initialLeft/t.initialCanvasWidth;e.style.left=t+"px";a=AvayaClientServices.Services.Collaboration.WhiteboardTextSizes[n]*a;e.style.fontSize=a+"px",this._adjustWidth(e),this._checkOutOfBounds(e,i)},o.dragStart=function(e,t){var i=e.target;this._clickData={eventX:e.evt.pageX/t,eventY:e.evt.pageY/t,x:i.x(),y:i.y()}},o.dragEnd=function(e,t){var i;this._clickData&&(i=e.target,l._moveShape(e.target,{selectionX:this._clickData.x,selectionY:this._clickData.y,newPositionX:i.x(),newPositionY:i.y()}),this._clickData=_)},e.startFunction=function(e,t,n){var a={x:e.offsetX/n,y:e.offsetY/n},o={x:e.offsetX/n,y:e.offsetY/n};a.x===o.x&&a.y===o.y&&(o.x+=.1,o.y+=.1);var r=new Konva.Line({points:[a.x,a.y,o.x,o.y],stroke:l._color,strokeWidth:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths[t],hitStrokeWidth:20,lineCap:"round",lineJoin:"round"});return r.setDragDistance(0),r.dragBoundFunction=h,l._drawingLayer.add(r),l._drawingLayer.draw(),l._canvas.onmousemove=function(e){var t,i;e.shiftKey?(i=e.offsetX/n-a.x,t=e.offsetY/n-a.y,i=Math.atan(t/i),Math.abs(i)>3*Math.PI/2/2/2?(o.x=a.x,o.y=e.offsetY/n):Math.abs(i)>Math.PI/2/2/2?(o.x=e.offsetX/n,o.y=a.y+(o.x-a.x)*Math.sign(i)):(o.x=e.offsetX/n,o.y=a.y)):(o.x=e.offsetX/n,o.y=e.offsetY/n),r.attrs.points=[a.x,a.y,o.x,o.y],l._drawingLayer.draw(),l._drawingStage.draw()}.bind(this),r}.bind(this),e.endFunction=function(e){l._canvas.onmousemove=_}.bind(this),t.startFunction=function(e,t,i){var n;return"FILLED"===t?n=new Konva.Rect({x:e.offsetX/i,y:e.offsetY/i,width:1,height:1,fill:l._color}):"STROKE"===t&&(n=new Konva.Rect({x:e.offsetX/i,y:e.offsetY/i,width:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths.LARGE,height:1,lineCap:"round",lineJoin:"round",stroke:l._color,strokeWidth:l._strokeWidth})),n.setDragDistance(0),n.dragBoundFunction=a,l._drawingLayer.add(n),l._drawingLayer.draw(),l._canvas.onmousemove=function(e){var t;e.shiftKey?(t=Math.min(e.offsetY/i-n.attrs.y,e.offsetX/i-n.attrs.x),e.offsetY<n.attrs.y&&e.offsetX>n.attrs.x?(n.width(-t),n.height(t)):e.offsetY>n.attrs.y&&e.offsetX<n.attrs.x?(n.width(t),n.height(-t)):(n.width(t),n.height(t))):(n.width(e.offsetX/i-n.attrs.x),n.height(e.offsetY/i-n.attrs.y)),l._drawingLayer.draw(),l._drawingStage.draw()}.bind(this),n}.bind(this),t.endFunction=function(e){l._canvas.onmousemove=_}.bind(this),i.startFunction=function(e,t,i){var n,a=e.offsetX/i,o=e.offsetY/i,r={x:e.offsetX/i,y:e.offsetY/i};return"FILLED"===t?n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},fill:l._color}):"STROKE"===t&&(n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},stroke:l._color,strokeWidth:l._strokeWidth})),n.setDragDistance(0),n.dragBoundFunction=s,l._drawingLayer.add(n),l._drawingLayer.draw(),l._canvas.onmousemove=function(e){r.x=e.offsetX/i,r.y=e.offsetY/i,e.shiftKey?(e=Math.min(r.y-o,r.x-a),n.radius({x:Math.abs(e)/2,y:Math.abs(e)/2}),r.x<a&&r.y>o?(n.x(a+e/2),n.y(o-e/2),n.initX=a+e/2,n.initY=o-e/2):(r.x>a&&r.y<o?(n.x(a-e/2),n.y(o+e/2),n.initX=a-e/2):(n.x(a+e/2),n.y(o+e/2),n.initX=a+e/2),n.initY=o+e/2)):(n.radius({x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2}),n.x(a+(r.x-a)/2),n.y(o+(r.y-o)/2),n.initX=a+(r.x-a)/2,n.initY=o+(r.y-o)/2),l._drawingLayer.draw(),l._drawingStage.draw()}.bind(this),n}.bind(this),i.endFunction=function(e){l._canvas.onmousemove=_}.bind(this),n.drawFunction=function(e,t){var i={x:e.offsetX/t,y:e.offsetY/t},n=[{x:0,y:0},{x:-10,y:-10},{x:-42,y:-10},{x:-42,y:10},{x:-10,y:10}],e=new Konva.Shape({fill:l._color,sceneFunc:function(e){e.beginPath(),e.moveTo(i.x,i.y);for(var t=1;t<n.length;t++)e.lineTo(i.x+n[t].x,i.y+n[t].y);e.closePath(),e.fillStrokeShape(this)}});return e._modelStart=i,e._modelRelativePoints=n,e._originalScale=t,e._shapeType="Stamp",e._selfRectCoordinates={minX:i.x-42,minY:i.y-10,maxX:i.x,maxY:i.y+10},e.getSelfRect=function(){return{x:this._selfRectCoordinates.minX,y:this._selfRectCoordinates.minY,width:this._selfRectCoordinates.maxX-this._selfRectCoordinates.minX,height:this._selfRectCoordinates.maxY-this._selfRectCoordinates.minY}},e.setDragDistance(0),e.dragBoundFunction=h,l._drawingLayer.add(e),l._drawingLayer.draw(),l._drawingStage.draw(),e}.bind(this)}e.prototype=Object.create(AvayaClientServices.Services.Collaboration.WhiteboardTools.prototype),AvayaClientServices.Renderer.Konva.KonvaWhiteboardTools=e}(),function(){"use strict";AvayaClientServices.Renderer.LoggerTags={KONVA_WHITEBOARD_RENDERER:"KonvaWhiteboardRenderer",KONVA_CONTENT_SHARING_RENDERER:"KonvaContentSharingRenderer"}}(),AvayaClientServices.Base.Library.Service.jQuery.addOnVersionChangedCallback(function(e){u=e})}();